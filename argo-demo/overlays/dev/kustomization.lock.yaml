apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app: demo
    env: dev
    project: flink-demo
  name: dev-flink
  namespace: dev-flink-demo
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app: demo
    env: dev
    project: flink-demo
  name: dev-flink
  namespace: dev-flink-demo
rules:
- apiGroups:
  - ""
  resources:
  - pods
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - apps
  resources:
  - deployments
  - deployments/finalizers
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
---
apiVersion: v1
data:
  CHECKPOINT_INTERVAL: 10 s
  PAIMON_CATALOG: paimon_catalog
  PAIMON_DATABASE: demo
  PAIMON_WAREHOUSE: s3://flink-demo/
  PIPELINE_NAME: pyflink-paimon-page-views-per-minute
  S3_ENDPOINT: https://minio.minio-tenant.svc.cluster.local
  S3_PATH_STYLE: "true"
kind: ConfigMap
metadata:
  labels:
    env: dev
  name: dev-demo-flink-s3-paimon-cm
  namespace: dev-flink-demo
---
apiVersion: v1
kind: Secret
metadata:
  labels:
    env: dev
  name: dev-flink-demo-minio-secret
  namespace: dev-flink-demo
stringData:
  S3_ACCESS_KEY: somekey
  S3_SECRET_KEY: somesecret
type: Opaque
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  labels:
    env: dev
  name: dev-demo-flink-ha-pvc
  namespace: dev-flink-demo
spec:
  accessModes:
  - ReadWriteMany
  resources:
    requests:
      storage: 1Gi
  storageClassName: longhorn
---
apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  labels:
    app: demo
    env: dev
    project: flink-demo
  name: dev-demo-flinkdeployment
  namespace: dev-flink-demo
spec:
  flinkConfiguration:
    execution.checkpointing.interval: 10s
    high-availability: kubernetes
    high-availability.storageDir: file:///flink-ha-data/ha
    kubernetes.operator.savepoint.format.type: NATIVE
    python.client.executable: /opt/venv/bin/python3
    python.executable: /opt/venv/bin/python3
    state.checkpoints.dir: file:///flink-ha-data/flink-ckpt
    state.savepoints.dir: file:///flink-ha-data/flink-sp
    taskmanager.numberOfTaskSlots: "2"
  flinkVersion: v1_20
  image: quay.io/colinchan2025/flink_base:dev
  job:
    args:
    - -py
    - /opt/flink/usrcode/app.py
    - -pyexec
    - /opt/venv/bin/python3
    entryClass: org.apache.flink.client.python.PythonDriver
    jarURI: local:///opt/flink/lib/flink-python-1.20.2.jar
    parallelism: 2
    state: running
    upgradeMode: stateless
  jobManager:
    replicas: 1
    resource:
      cpu: 1
      memory: 2048m
  mode: native
  podTemplate:
    spec:
      containers:
      - env:
        - name: PYTHONUNBUFFERED
          value: "1"
        - name: JAVA_TOOL_OPTIONS
          value: -Djavax.net.ssl.trustStore=/etc/ssl/truststore/cacerts -Djavax.net.ssl.trustStorePassword=changeit
        envFrom:
        - configMapRef:
            name: dev-demo-flink-s3-paimon-cm
        - secretRef:
            name: dev-flink-demo-minio-secret
        name: flink-main-container
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          runAsNonRoot: true
        volumeMounts:
        - mountPath: /etc/ssl/truststore
          name: minio-ca
        - mountPath: /flink-ha-data
          name: flink-ha-volume
      securityContext:
        fsGroup: 9999
        runAsGroup: 9999
        runAsUser: 9999
        seccompProfile:
          type: RuntimeDefault
      volumes:
      - configMap:
          name: minio-ca
        name: minio-ca
      - name: flink-ha-volume
        persistentVolumeClaim:
          claimName: dev-demo-flink-ha-pvc
  serviceAccount: dev-flink
  taskManager:
    replicas: 2
    resource:
      cpu: 1
      memory: 4096m
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    cert-manager.io/issuer: npe-acme-clusterissuer
    cert-manager.io/issuer-kind: ClusterIssuer
  labels:
    env: dev
  name: dev-demo-ingress
  namespace: dev-flink-demo
spec:
  ingressClassName: nginx
  rules:
  - host: ds01-flink.venetianqa.local
    http:
      paths:
      - backend:
          service:
            name: dev-demo-flinkdeployment-rest
            port:
              number: 8081
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - ds01-flink.venetianqa.local
    secretName: dev-demo-ingress-tls
